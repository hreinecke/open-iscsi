prefix	= @prefix@
exec_prefix = @exec_prefix@
sbindir	= @sbindir@
mandir	= @mandir@
etcdir	= /etc
vardir	= /var/lib/isns
systemddir = $(prefix)/lib/systemd/system
datarootdir = @datarootdir@

SBINDIR	= $(DESTDIR)$(sbindir)
ETCDIR	= $(DESTDIR)$(etcdir)
CFGDIR	= $(ETCDIR)/isns
MANDIR	= $(DESTDIR)$(mandir)
VARDIR	= $(DESTDIR)$(vardir)
SDSDIR  = $(DESTDIR)$(systemddir)

CC	= @CC@
CPPFLAGS= @CPPFLAGS@
CFLAGS	= @CFLAGS@ -I.
LDFLAGS	= @LDFLAGS@
INSTALL = @INSTALL@

ISNSD	= isnsd
ISNSDOBJS = isnsd.o
ISNSDD	= isnsdd
ISNSDDOBJS = isnsdd.o local.o
ISNSADM	= isnsadm
ISNSADMOBJS	= isnsadm.o

SRV	= $(ISNSD) $(ISNSDD) $(ISNSADM)
LIB	= libisns.a
LIBOBJS	= server.o \
	  client.o \
	  objects.o \
	  callback.o \
	  timer.o \
	  vendor.o \
	  db.o \
	  db-file.o \
	  db-policy.o \
	  relation.o \
	  scope.o \
	  message.o \
	  security.o \
	  authblock.o \
	  policy.o \
	  register.o \
	  query.o \
	  getnext.o \
	  deregister.o \
	  esi.o \
	  scn.o \
	  dd.o \
	  entity.o \
	  portal-group.o \
	  storage-node.o \
	  domain.o \
	  simple.o \
	  tags.o \
	  attrs.o \
	  export.o \
	  socket.o \
	  slp.o \
	  error.o \
	  logging.o \
	  config.o \
	  parser.o \
	  buffer.o \
	  pidfile.o \
	  sysdep-unix.o \
	  util.o \
	  bitvector.o \
	  pki.o \
	  mdebug.o
SECLINK	= @SECLIBS@
SLPLINK	= @SLPLIBS@

all: $(LIB)

programs: $(SRV)

install: $(SRV)
	$(INSTALL) -d $(SBINDIR)
	$(INSTALL) -m 755 $(SRV) $(SBINDIR)
	$(INSTALL) -d $(MANDIR)/man8
	$(INSTALL) -m 644 doc/isnsadm.8 $(MANDIR)/man8
	$(INSTALL) -m 644 doc/isnsd.8 $(MANDIR)/man8
	$(INSTALL) -m 644 doc/isnsdd.8 $(MANDIR)/man8
	$(INSTALL) -d $(MANDIR)/man5
	$(INSTALL) -m 644 doc/isns_config.5 $(MANDIR)/man5
	$(INSTALL) -d $(CFGDIR)
	$(INSTALL) -m 644 etc/isnsd.conf $(CFGDIR)
	$(INSTALL) -m 644 etc/isnsdd.conf $(CFGDIR)

install_service:
	$(INSTALL) -d $(SDSDIR)
	$(INSTALL) -m 644 isnsd.service $(SDSDIR)
	$(INSTALL) -m 644 isnsd.socket $(SDSDIR)

clean distclean::
	rm -f *.o $(LIB) $(SRV) *~

distclean::
	rm -f config.h Makefile config.status config.log
	rm -rf autom4te.cache

message.o: message.c
	gcc $(CFLAGS) $(CPPFLAGS) $(IQNFLAGS) -c -o $@ message.c

$(LIB): $(LIBOBJS)
	ar cr $@ $(LIBOBJS)

$(ISNSD): $(ISNSDOBJS) $(LIB)
	gcc $(CFLAGS) -o $@ $(ISNSDOBJS) $(LIB) $(SECLINK) $(SLPLINK)

$(ISNSDD): $(ISNSDDOBJS) $(LIB)
	gcc $(CFLAGS) -o $@ $(ISNSDDOBJS) $(LIB) $(SECLINK) $(SLPLINK)

$(ISNSADM): $(ISNSADMOBJS) $(LIB)
	gcc $(CFLAGS) -o $@ $(ISNSADMOBJS) $(LIB) $(SECLINK) $(SLPLINK)

depend:
	gcc $(CFLAGS) -M `ls *.c` > .depend

-include .depend
