#!/bin/bash
#
# Build an open-iscsi source rpm
#
# To Do:
# - add "verbose" mode
# - use getopt for option handling
# - fix OBS/osc interaction
#

RPM="open-iscsi"
BRANCH=$(git rev-parse --abbrev-ref HEAD)
VERSION="2.0-873"
MASTER_TAG="2.0.873"
MASTER_HEAD="sles12-base"
DESTDIR=
NUM_PATCHES=2
uncommitted_changes=0

# if using osc ...
OBS_BRANCH=home:hreinecke:branches
OBS_PRJ=SUSE:SLE-12:GA
OSC="osc -A https://api.suse.de"
TMPDIR=


while [ $# -gt 0 ] ; do
    case "$1" in
	-c|--clean)
	    remove_destdir=1
	    shift
	    ;;
        -d)
            DESTDIR="$2"
            shift 2
            ;;
        --destdir*)
            DESTDIR="${$1#*=}"
            shift
            ;;
        -b)
            BRANCH="$2"
            shift 2
            ;;
        --branch=*)
            BRANCH="${1##*=}"
            shift
            ;;
	-o|--use-osc)
	    use_osc=1
	    shift
	    ;;
        -f|--force)
            force=1
	    update=
            shift;
            ;;
	-m|--maintenance)
	    OBS_PRJ=SUSE:SLE-12:Update:Test
	    OSC="osc -A https://api.suse.de"
	    shift
	    ;;
        -u|--update)
            update=1
	    force=
            shift
            ;;
        --uncommitted-changes)
            uncommitted_changes=1
            shift
            ;;
        *)
            echo "Usage: build_rpm [-c|-f|-o|-u] [-d dir|--destdir=DIR] " \
                 "[-b BRANCH|--branch=BRANCH] [--uncommitted-changes]"
            exit 1
            ;;
    esac
done

if ! which git > /dev/null ; then
    echo "git not found, cannot continue"
    exit 1
fi

if [ -d "$DESTDIR" ] ; then
    if [ -z "$force" ] && [ -z "$update" ] ; then
        echo "directory $DESTDIR exists, cannot continue"
        exit 1
    elif [ -z "$update" ] ; then
        if ! rm -rf "$DESTDIR" ; then
            echo "Cannot remove directory $DESTDIR"
            exit 1
        fi
	mkdir -p "$DESTDIR"
    fi
elif [ -n "$DESTDIR" ] ; then
    mkdir -p "$DESTDIR"
else
    DESTDIR=$(mktemp -d --tmpdir $RPM-XXXXXXXX)
    if [ ! -d "$DESTDIR" ] ; then
	echo "Cannot create directory $DESTDIR"
	exit 1
    fi
fi

if [ -n "$use_osc" ] ; then
    pushd $DESTDIR
    if ! $OSC meta pkg $OBS_BRANCH:$OBS_PRJ $RPM > /dev/null 2>&1 ; then
	$OSC branch -m "Update with latest fixes" $OBS_PRJ $RPM
    fi
    $OSC co --current-dir $OBS_BRANCH:$OBS_PRJ $RPM
    TMPDIR=${DESTDIR}
    DESTDIR="${DESTDIR}/$RPM"
    popd
fi

#
# to be able to convert this git archive into the proper format
# for package building, we want a spec file, a changes file,
# a base tar file, and zero or more patch files
#

# create the spec and changes files -- Note that this
# gets the HEAD of these files from the specified branch,
# not from the current workspace
git show $BRANCH:rpm/$RPM.spec > $DESTDIR/$RPM.spec
git show $BRANCH:rpm/$RPM.changes > $DESTDIR/$RPM.changes

# also create the firewall service file
git show ${BRANCH}:rpm/${RPM}-firewall.service >$DESTDIR/${RPM}-firewall.service

# create the base tar file containing the open-iscsi base code
git archive --format=tar --prefix=$RPM-$VERSION/ "$MASTER_TAG" \
    | bzip2 > $DESTDIR/$RPM-$VERSION.tar.bz2

# patch1: create a diff file for changes between the base version
# and the update tag
git diff $MASTER_TAG..$MASTER_HEAD | bzip2 > $DESTDIR/$RPM-git-update.diff.bz2

# patch2: create a diff for SUSE-specific changes
git diff $MASTER_HEAD..HEAD | \
	bzip2 > $DESTDIR/$RPM-sles12-update.diff.bz2

# if the user specified this then get all changes not even checked in
# and patch them into the spec file as "Patch$NEXT_PATCH"
if (( $uncommitted_changes )) ; then
    echo "WARNING: Including uncommitted changes for testing." >&2
    echo "         Don't submit the package to Autobuild!"     >&2

    patchname=$RPM-$(date -u +%Y-%M-%d_%T_%Z).diff
    git diff $BRANCH > $DESTDIR/$patchname

    sed -i \
	"/Patch${NUM_PATCHES}:.*$/aPatch${NEXT_PATCH}:         $patchname" \
	$DESTDIR/$RPM.spec
    sed -i \
	"/%patch${NUM_PATCHES} -p1/a%patch${NEXT_PATCH} -p1" \
	$DESTDIR/$RPM.spec
fi

echo "$RPM src rpm copied to $DESTDIR"

if [ -n "$use_osc" ] ; then
    pushd $DESTDIR
    osc ar
    osc ci --message="Checked in from git branch $OBS_BRANCH"
    osc sr
    popd
fi

if [ -n "$remove_destdir" ] ; then
    rm -rf $DESTDIR
    if [ "$TMPDIR" ] ; then
	rm -rf $TMPDIR
    fi
fi
